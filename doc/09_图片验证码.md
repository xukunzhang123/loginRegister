## 图片验证码
为了防止机器人频繁登录网站，或者网站恶意被登录，很多用户登录和注册系统都提供了图形验证码功能，在Django中实现图片验证码功能非常简单，有现成的第三方库可以使用，不必自己开发，这个库叫做 django-simple-captcha.


#pip install django-simple-captcha 下载插件
#python .\manage.py migrate
https://django-simple-captcha.readthedocs.io/en/latest/usage.html
```
Installation
Install django-simple-captcha via pip: pip install  django-simple-captcha

Add captcha to the INSTALLED_APPS in your settings.py

Run python manage.py migrate

Add an entry to your urls.py:

urlpatterns += [
    path('captcha/', include('captcha.urls')),
]
```
### Django表单
前面都是手工在HTML文件中编写表单form元素，然后在views.py的视图函数中接收表单中的用户数据，再手写代码进行验证，最后使用ORM进行数据库的增删改查。这样费时费力，整个过程比较复杂，而且有可能写的不太得当，数据验证也比较麻烦。如果表单拥有几十上百个字段，有不同的数据特点，如果也是用手工的方式，其效率和正确性都将无法得到保障。基于此，Django在内部集成了一个表单功能，以面向对象的方式，直接使用Python代码生成HTML表单代码，专门帮我们处理表单相关的内容。

Django的表单给我们提供了下面三个主要功能
· 准备和重构数据用于页面渲染
· 为数据创建HTML表单元素
· 接收和处理用户从表单发送过来的数据

编写Django的form表单，非常类似我们再模型系统里面编写一个模型。在模型中，一个字段代表数据表的一列，而form表单中的一个字段代表<form>中的一个<input>元素。

Django 表单 https://docs.djangoproject.com/zh-hans/4.2/topics/forms/ 
## 创建表单模型
新建一个forms.py的表单文件；login/forms.py  (新建文件)
```python
from captcha.fields import CaptchaField
from django import forms


class LoginForm(forms.Form):
    username = forms.CharField(label="用户名", required=True, min_length=4, max_length=128)
    password = forms.CharField(label="密码", required=True, min_length=4, max_length=10)
    captcha = CaptchaField()
 #alt + enter 快速导入一个类
```
## 视图逻辑优化
#login/views.py
```python
from login.forms import LoginForm

def login(request):
    # 请求方法为POST
    if request.method == "POST":
        #修改1： 实例化表单对象    
        login_form = LoginForm(request.POST)
        #修改2： 验证表单数据的合法性
        if login_form.is_valid():
            #修改3：获取表单填写的数据，数据清洗
            username = login_form.cleaned_data.get('username')
            password = login_form.cleaned_data.get('password')
            user = SiteUser.objects.filter(name=username, passwoed=password).first()
            if user:
                # 用户存在
                request.session['is_login'] = True
                request.session['user_id'] = user.id
                request.session['username'] = user.name
                return redirect('/index/')
            else:
                message = "用户名或密码错误"
                #修改4： locals()以字典方式返回当前所有的变量
                # eg:{'message':'xxxx', 'login_form':'xxxx'}           
                return render(request, 'login/login.html',locals())
        else:
            message = "填写的登录信息不合法"
            # return render(request, 'login/login.html', {'message': message})
            return render(request, 'login/login.html', locals())
        #return redirect('/index/')
    # 请求方式是GET请求
    login_form = LoginForm()
    return render(request, 'login/login.html',locals())
```
## Template页面优化
#templates/login/login.html （部分修改）
```python
<h3 style="text-align: center">用户登录</h3>
#修改1：不同的报错，提示不同的信息
{% if login_form.captcha.errors %}
<div class="alert alert-warning" role="alert">
    <strong>登录失败!</strong> 验证码不正确
</div>
{% elif message %}
    <div class="alert alert-warning" role="alert">
        <strong>登录失败!</strong> {{ message }}
    </div>
{% endif %}

<form action="/login/" method="post">

{% csrf_token %}
<div class="form-group">
    #修改2：表单里面是啥，这里就显示啥
    <label>{{ login_form.username.label }}</label>
    <input type="text" class="form-control" name="username">
</div>
<div class="form-group">
    ##修改3：表单里面是啥，这里就显示啥
    <label>{{ login_form.password.label }}</label>
    <input type="password" class="form-control" name="password">
    <small class="form-text text-muted">密码必须是字母、数字和特殊符号组成.</small>
</div>

#修改4：最重要的是添加验证码的表单
<div class="form-group">
    <label>{{ login_form.captcha.label }}</label>
    {{ login_form.captcha }}
</div>
```

## 验证是否正确
http://127.0.0.1:8888/login/

